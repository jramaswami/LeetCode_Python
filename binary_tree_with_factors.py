"""
LeetCode :: March 2021 Challenge :: Binary Tree With Factors
jramaswami
"""
from typing import *


MOD = pow(10, 9) + 7


class Solution:
    def numFactoredBinaryTrees(self, arr: List[int]) -> int:
        arr.sort()
        trees = dict()
        for p in arr:
            trees[p] = 1
            for a in arr:
                if a * a > p:
                    break
                for b in arr:
                    if a * b > p:
                        break
                    if p == a * b:
                        t = (trees[a] * trees[b]) % MOD
                        if a == b:
                            trees[p] = (trees[p] + t) % MOD
                        else:
                            t = (t * 2) % MOD
                            trees[p] = (trees[p] + t) % MOD

        soln = 0
        for t in trees.values():
            soln = (t + soln) % MOD
        return soln



def test_1():
    arr = [2, 4]
    assert Solution().numFactoredBinaryTrees(arr) == 3


def test_2():
    arr = [2, 4, 5, 10]
    assert Solution().numFactoredBinaryTrees(arr) == 7


def test_3():
    arr = [2,4,5,7,10,20,22,35]
    assert Solution().numFactoredBinaryTrees(arr) == 23


def test_4():
    arr = [2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]
    assert Solution().numFactoredBinaryTrees(arr) == 77

def test_5():
    """TLE"""
    arr = [26065760,16605,149410800,114766080,10639200,2337400,9878400,20,147829500,1233792,259451400,819,306362250,28675,215843040,40,100440,69696,480438000,10665270,5,605052000,77134200,9124815,47,8268750,112197320,13320,65832900,255,440831160,10058360,110384505,10672,23607936,522,6762690,2,63799470,481075200,19,201600,75810,305182080,260400,8,3273600,22704000,208495,610233750,14165760,553536000,8660960,320,3798275,483,75075840,152028576,2377188,7,118288632,603313920,266759325,2205,60412800,165,44616,2730,1141140,281413440,586265400,612864,101574,59875200,34510080,307795950,158193000,47773440,11088,954068544,2182950,201766320,6615,5016,44015400,707097600,8537760,2112,36660,13200,510,13258080,103061700,58988160,3927528,82368,141178800,804384,95961600,300762000,763280,807831360,368552184,1470,46612720,2970,506,49,312340050,4088448,66721200,785862,231525000,257014800,7728,399106400,63122598,574182000,10,5769225,1008,60054750,1848,19152,196560,63645120,79920,22876360,26925360,175204250,47520,35721000,38304,135036000,194660928,158029872,99,1617330,95208750,1334,6320160,7680,195,17,211680,1046115,3510864,789626880,47462625,98017920,1931160,240295020,1386,28089600,969696,168116256,45600,205791300,665280,237405,192384192,7551600,806000,1302840,573830400,1184,149960160,221205600,30,375464160,30636225,34551360,685721925,89413632,442567840,20896512,230732964,1852200,530323200,9,22346280,15,3,1520,138040320,376200,43570800,75620160,218196000,2629575,7469280,4158,42831360,18711,7980,583783200,114,727895168,7737600,10240,44884224,168918750,764694000,102400,32901120,90854400,11760,276619200,160524000,789994800,5560100,183540,598461696,675,275044,434511000,13046200,869891904,17752896,158754816,1341360,601965000,109296000,70048800,371205120,807240000,122892,336,2188032,8255520,8640,130764375,459543375,12773376,47604480,317813760,226437120,379050,10125,11674800,367536000,733471200,5566,17608800,2732400,90090,1457280,17612,8209344,37264500,33264,174825,49680,44400,831049065,53538870,32078592,699791400,26333160,2903040,144003552,810810,23794560,191808,943734240,2782560,698320,308730240,1155,49815,17463600,117621504,292175,4241160,126554400,124073040,91171080,21252,46626840,92778000,278784,761866560,9078160,1842750,377,24554880,264757248,25725,95135040,187572,520260,33551232,21593880,4,338688,30628000,27930,471517200,3187800,84795480,3672,126520240,936249600,484362060,4440,2094840,41238720,596160,1824768,207210960,668850,149610240,123039000,3586440,149040,915141150,122880,317497950,345966390,553512960,3329480,4989600,4000260,567600,30810780,2965248,17342,91737360,547272180,18523890,2605680,878169600,132,46530,602152650,528,70326144,13,12579840,689584896,172692000,1398600,46,66189312,218660,36479520,42,4608450,580,117180,378,39,64680,2175600,56246400,6696000,4331250,9288,1029,70239150,209230560,158466000,1044,450774720,245888125,303750,6770400,245,160,18928,336232512,161708400,8820,5860512,32322240,37,208320,1552320,27675,1245090,88014080,7567875,36750,12612600,947232000,294840,614250,303937920,4290,313490,175,13650,77974974,6090084,82114560,317440,45841950,5541120,21120,251067600,658560,716100,15080,931,6269400,73920,271656000,119700,8309080,7092800,382391100,143783640,9997344,5762400,63617400,94,258073200,216,7761600,36,360855,614122560,95472,6138000,72520,10445760,7827720,297,11623500,1104840,765700,711022,4833675,465,73914750,36614025,29822000,3690,94802400,6494460,2076624,937213200,222,82320,11880,343814625,57513456,50086080,2760,5236,5400,1320660,115552008,316885800,997436160,698544000,2947560,472556160,13156,9219840,4698,39379680,227525760,213857280,1102500,1330368,16275,44430750,2623920,677476800,21891870,64247040,461465928,28,104904000,746871840,398994750,8197200,11,37243800,561330,37762200,251915300,141261120,32440320,33331200,142560,905022720,1747200,903,37889280,1484280,159600,461260800,345290400,960664320,417384000,156554400,944055000,552160,445209600,20275200,13751605,676,17783955,109296,45158400,647184384,3696000,836,4410,870688,340454400,747225,173250,138087180,3278250,739200,1486660,171766980,89806400,261424800,2539350,14406000,332640,635040,119451024,47376,22,503268480,20150,94752,128760,497871360,967680,6199200,1076400,44100,31775,7380,601920,32,439538400,12,130014720,227360,12636,7738080,223440,81635400,127925280,163430400,147087360,235,314503200,436050,27,14577750,18574920,4725,39560400,9384480,422294400,33094656,10267200,191520,229824,908160,88200,129043200,17767400,589248,677376000,121212000,18258240,6583290,385839168,47879370,454365450,19740,130734450,10857,162983520,105498470,60680,416640,18247680,222667200,683020800,81840,608256,1190400,276773112,7560,994593600,21,8288280,70,461760,156854880,7776,14,27927900,14414400,756689472,4700,309960000,26,27350400,1534680,24615360,29,25872,9070600,39207168,81496800,9065,361584000,322801200,35,223171200,76492500,435120,105,25225200,888,84480,100,689472,33758208,111460500,292950,11919600,2604000,1740024,13365,189885696,47230560,229729500,9943560,213736320,166486320,26364,69120,743795712,18,812,20433600,402192,933570,213754464,3720,974647080,200103750,19305216,1050,360360,9687600,45,5755860,3150,990,10461150,83516400,86856000,145981440,2905875,17839920,18810,256132800,604195200,13912800,62361600,8856000,269253600,56022120,730445040,134918784,12727260,7056,25489800,1430352,22050,177748830,476,957264000,153679680,206283,51802740,91400400,737280,140507136,2550240,152064,1190025,20956320,699840,51060375,4416984,4424112,8251320,7082880,246758400,5405400,4300800,90882,283852800,183439872,85162560,208,596037000,34234200,2808,5880,31,6,524860560,55730250,738904320,7640325,231,16,190541120,245460600,4692240,33858,2092230,4791960,37200,838476240,3553480,330750,7794864,180164250,640493568,764951040,30139200,277214400,154752000,570,1200,2697240,61380,80724000,2538900,319368525,26231040,17321920,10920,273977424,1003625,798427440,279655875,54794040,34,10278240,6580,323242920,21090,698544,2279970,735,648600,589680000,52184800,11761200,433048,948179232,161200,5082,119658000,24927240,537468750,124366704,101072400,375419616,576240,316108800,176400,304995600,1881600,6758400,374220,1041600,2609240,289578240,129360,2882880,20311200,210,7084,43,6988800,5852,1480,759666600,38,122145408,25920,182125,178516800,175560,10959300,1720320,86666580,4890600,55800,613800,457301700,220,891,3990,1114560,1143900,577290240,397608960,133056,7916160,458816400,49059780,120,53302200,6510,464531760,903960,436449000,2639340,40449024,343145400,1755,25548768,1494450,23,59925600,275730840,24,53550,91080,12052800,4409856,380730000,38829,3071250,83825280,36918450,8225,41,161954100,769004600,68302080,44,30903444,33690800,6048,24137190,198567936,25137,34596639,349701300,57915648,988473024,4653,3501576,16960185,287894880,6272640,5950560,916260800,908820,79682400,11704,2791280,33,109588080,25,16240,139150,26516160,1934520,132990,205197300,42230160,4105728,322560,545824818,2317680,14889600,19008,765,4074840,56216160,962,549120,18792,371665,287963910,7814664,77616000,13020,61538400,253222200,280558080,695756880,496860,352287936,81021600,310464000,885600,106916040,104160,7175,819720,306,16896,106260,223534080,71245440,1404,342835200,28637070,39989376,1164240,137940,864448200,15257088,4800,496419840,1166220,4161500,43467840,10270260,392,121544800,924,36691200,775,356928,51480,9041760,164052000,458419500,92250,38304000,7436,482630400,16502640,48,107520,11525760,900144000,9427968,1845,141482880,491604750,6142500,329,3973200,3515400,390,822603600,290727360,8323000,35786400,470448,32448]
    assert Solution().numFactoredBinaryTrees(arr) == 847010468
